<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoulangePro - Connexion</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <img src="images/logo.png" alt="BoulangePro Logo" class="auth-logo">
                <h1>BoulangePro</h1>
            </div>
            
            <h2>Connexion</h2>
            
            <div class="auth-alert" id="auth-alert"></div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" value="demo@boulangeproapp.com" required>
                </div>

                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" value="password123" required>
                </div>

                <button type="submit" class="btn primary full-width">Se connecter</button>
            </form>

            <div class="demo-info">
                <p><strong>Utilisateur de démonstration :</strong></p>
                <p>Email: demo@boulangeproapp.com</p>
                <p>Mot de passe: password123</p>
            </div>
            
            <div class="auth-footer">
                <p>Vous n'avez pas de compte ? <a href="register.html">S'inscrire</a></p>
            </div>
        </div>
    </div>
    
    <!-- Charger l'API -->
    <script src="js/api.js"></script>

    <!-- Script d'authentification -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM chargé dans login.html');

            // Attendre que l'API soit chargée
            setTimeout(function() {
                console.log('Vérification de l\'API dans login.html');

                // Vérifier si l'API est disponible
                if (!window.api) {
                    console.error('API non disponible');
                    return;
                }

                console.log('API disponible dans login.html');

                // Vérifier si l'utilisateur est déjà connecté
                if (window.api.auth.isAuthenticated()) {
                    window.location.href = 'index.html';
                }

                // Gérer la soumission du formulaire
                const loginForm = document.getElementById('login-form');
                const authAlert = document.getElementById('auth-alert');

                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Formulaire de connexion soumis');

                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    console.log('Tentative de connexion avec:', email);

                    // Afficher un message de chargement
                    authAlert.textContent = 'Connexion en cours...';
                    authAlert.style.display = 'block';
                    authAlert.className = 'auth-alert info';

                    // Utiliser une approche sans async/await pour éviter les problèmes potentiels
                    window.api.auth.login({ email, password })
                        .then(function(response) {
                            console.log('Connexion réussie:', response);

                            // Vérifier la réponse
                            if (response && response.token) {
                                // Afficher un message de succès
                                authAlert.textContent = 'Connexion réussie! Redirection...';
                                authAlert.className = 'auth-alert success';

                                // Rediriger vers la page intermédiaire avec le token en paramètre
                                console.log('Redirection vers la page intermédiaire...');

                                // Redirection vers la page intermédiaire avec le token en paramètre
                                setTimeout(function() {
                                    window.location.href = 'auth-success.html?token=' + encodeURIComponent(response.token);
                                }, 1000);
                            } else {
                                throw new Error('Réponse invalide du serveur');
                            }
                        })
                        .catch(function(error) {
                            console.error('Erreur de connexion:', error);

                            // Afficher l'erreur
                            authAlert.textContent = error.message || 'Erreur de connexion au serveur';
                            authAlert.style.display = 'block';
                            authAlert.className = 'auth-alert error';
                        });
                });
            }, 500); // Attendre 500ms pour s'assurer que l'API est chargée
        });
    </script>
</body>
</html>